/**
    File:   gulpfile.js
    For:    Boulanger.com
    Author: Maxime Blanquart
    With:   Guillaume Fievet


    88888888888888888888888888888888888888888888888888888888888P"""""""""""""""88888888888888888888888888888888888888888888888888888888
8888888888888888888888888888888888888888888888888P""°```````````````````````````'"""88888888888888888888888888888888888888888888888
888888888888888888888888888888888888888888P"`````````````````````````````````````````````"78888888888888888888888888888888888888888
8888888888888888888888888888888888888888P°``````````````````````````````````````````````````788888888888888888888888888888888888888
888888888888888888888888888888888888888``````````````````````````````````````````````````````'8888888888888888888888888888888888888
88888888888888888888888888888888888888[```````````````````````````````````````````````````````'888888888888888888888888888888888888
8888888888888888888888888888888888888P``````````````````````````````````````````````````````````88888888888888888888888888888888888
8888888888888888888888888888888888888°``````````````````````````````````````````````````````````78888888888888888888888888888888888
8888888888888888888888888888888888888`````````________`````````````````````````________,````````]8888888888888888888888888888888888
888888888888888888888888888888888888°`````.J888888888888__`````````````````.J888888888888L,`````]8888888888888888888888888888888888
88888888888888888888888888888888888P````_/°````8888_J"788888_```````````J888888"LJ888P````'"L````8888888888888888888888888888888888
88888888888888888888888888888888888[```'```````````"88L,788888,````````J8888P__8P"``````````'````8888888888888888888888888888888888
88888888888888888888888888888888888[``````````````````'88LJ788°````````78"\J8P"``````````````````7888888888888888888888888888888888
88888888888888888888888888888888888°````````````````````788L````````````.J88°````````````````````]888888888888888888888888888888888
88888888888888888888888888888888888```````````````````````'888,````````]8"```````````````````````]888888888888888888888888888888888
88888888888888888888888888888888888````````__88888888L_````]888````````'`````._J88888888L,```````]888888888888888888888888888888888
88888888888888888888888888888888888``````J8888888888888888,'888[``````````.J888888888888888L,````]888888888888888888888888888888888
88888888888888888888888888888888888````8888888888888888888°`888[```````````8888888888888888P""8888888888888888888888888888888888888
88888888888888888888888888888888888```]"""°````````````````]888[`````````````````````````````````]888888888888888888888888888888888
88888888888888888888888888888888888````````````````````````]888[`````````````````````````````````]888888888888888888888888888888888
88888888888888888888888888888888888L```````````````````````]888[`````````````````````````````````]888888888888888888888888888888888
8888888888888888888888888888888888888,`````````````````````8888[`````````````````````````````````J888888888888888888888888888888888
88888888888888888888888888888888888888,```````````````````.8888[````````````````````````````````]8888888888888888888888888888888888
88888888888888888888888888888888888L`'8,`````````````````.88888[``````````````````````````````]888888888888888888888888888888888888
8888888888888888888888888888888888888`'888__________J`.88888888`````````'"",```````````````_JP`]88888888888888888888888888888888888
8888888888888888888888888888888888888L`788]88[````````]888`]888````````````]`````'""888888"88`]888888888888888888888888888888888888
88888888888888888888888888888888888888[`"8,'88L````````7[``]88P``````````````````````.88P`]8[`J888888888888888888888888888888888888
888888888888888888888888888888888888888```8,'888,``````````'88[`````````````````````]88P`]8[`]8888888888888888888888888888888888888
8888888888888888888888888888888888888888,`'7_,88888_,```````888,````.J8[`````````._888°`.8°`.88888888888888888888888888888888888888
88888888888888888888888888888888888888888[``78,]8888888888888888888888888,```_8888888``J8°``888888888888888888888888888888888888888
888888888888888888888888888888888888888888[```8L,`'788888888888P°``"88888888888888"°.J88``.8888888888888888888888888888888888888888
8888888888888888888888888888888888888888888[```888[````'788888P``````788888888"``````J°``]88888888888888888888888888888888888888888
88888888888888888888888888888888888888888888L,``7888_``````````'""""""``````````````8°``J888888888888888888888888888888888888888888
8888888888888888888888888888888888888888888888,``'888878``````````````````````````.8```J8888888888888888888888888888888888888888888
88888888888888888888888888888888888888888888888,``'888````'""`_______,```````````J"``]888888888888888888888888888888888888888888888
888888888888888888888888888888888888888888888888[``'8L`````````888888[``````````8```J8888888888888888888888888888888888888888888888
88888888888888888888888888888888888888888888888888,`]8,````````]8888[``````````P```J88888888888888888888888888888888888888888888888
888888888888888888888888888888888888888888888888888,``°````````88888L````````````J8888888888888888888888888888888888888888888888888
8888888888888888888888888888888888888888888888888888L_````````8888P88[``````````J88888888888888888888888888888888888888888888888888
888888888888888888888888888888888888888888888888888888L```````8888888[`````````8888888888888888888888888888888888888888888888888888
8888888888888888888888888888888888888888888888888888888L``````'888888°```````J88888888888888888888888888888888888888888888888888888
888888888888888888888888888888888888888888888888888888888L`````88888[``````]8888888888888888888888888888888888888888888888888888888
88888888888888888888888888888888888888888888888888888888888_```]8888[```_J888888888888888888888888888888888888888888888888888888888
88888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
88888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
88888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
88888888888888888888888888888888888````88°```78```]````````]8888888P`````8888````````'88````````]8888888888888888888888888888888888
88888888888888888888888888888888888[```8P````]P```J````.___J8888888``````]888```.8,```]8````.___J8888888888888888888888888888888888
88888888888888888888888888888888888[```8[````][``.8````'"""7888888P``._```788```'8°```88````'"""78888888888888888888888888888888888
888888888888888888888888888888888888,``'``],`````]8````````]888888°``]8[```88````````'88````````]8888888888888888888888888888888888
888888888888888888888888888888888888L`````8[`````J8````]888888888°`````````]8```]8````88````]88888888888888888888888888888888888888
8888888888888888888888888888888888888`````8[````]88````````]8888P```.__,```]8```]8[```88````````]8888888888888888888888888888888888
8888888888888888888888888888888888888_____8L____888________J8888L___J888____L___J8L___88________J8888888888888888888888888888888888
88888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
88888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888888
888888888888888888"""""788P""""88P"""88P""``""788P"""78P"""7""""88P"""7P"""""88"""""788P"°``""888"""78""""888""``'"8888888888888888
88888888888888888[`````'88[`````8[```8[````````78[````8[```],```]8```.8[`````88`````]8`````````7L```]8````]P````````888888888888888
88888888888888888°``````]8[`````][```8````8[```]8[````][```]8,``````]88[`````88`````]P```]88````8```]8````]````"88__888888888888888
8888888888888888P```]```]8[``````[```8````8[```]8[````'°```]88,`````888[```,`"``.```][```]88````8```]8````]L``````"7888888888888888
8888888888888888°```"````8[```8,`````8````8[```]8[``]8`````]888````8888[```[````]```][```]88````8```]8````]888L,````'88888888888888
8888888888888888`````````][```78`````8,```8[```]8[``]8,````]888````8888[```8````8```]L```]8P````8```]8````]```'88````88888888888888
888888888888888[```]8L````[```]8[````8L````````J8[``]8[````]888````8888[```8,``]8```]8_```````.88L```````J8L```````.888888888888888
88888888888888888888888_88888J88888LJ8888____J8888J8888L88J88888J8J88888JLJ88_J88LJL88888____888888____J888888____88888888888888888
 
 

    => TODOLIST
    =======================================
    * Ajouter des sourcemaps aux fichiers
    * Réindenter les fichiers SRC
    * Concaténer les fichiers sur DIST
    * Minifier les fichiers DIST
    =======================================
*/
	var fs             = require('fs');
	var gulp           = require('gulp');
	// var webserver      = require('gulp-webserver');
	var argv           = require('yargs').argv;

	if(process.argv[3]!=undefined){var current=process.argv[3].substring(2)}else{current="20160312-saint-valentin"}

	var config 		   = {dest:'/opt/webroot/cofax/static/bcom/desktop/evenements/'+current}
	var ftp            = require('gulp-scp2');
	var ssh 	       = require('gulp-ssh');
	var ssh 		   = new ssh({ignoreErrors: false,sshConfig: config})

	var htmlmin        = require('gulp-htmlmin');
	var concat         = require('gulp-concat');
	var rename         = require('gulp-rename');
	var replace 	   = require('gulp-replace');

	var prettify       = require('gulp-jsbeautifier');
	var jshint         = require('gulp-jshint');
	var uglify         = require('gulp-uglify');

	var less           = require('gulp-less');
	var lessAutoprefix = require('less-plugin-autoprefix');
	var autoprefix     = new lessAutoprefix();
	var cssmin         = require('gulp-cssmin');
/*
	var cache          = require('gulp-cache');
	var imagemin       = require('gulp-imagemin');
*/
	var injectfile     = require('gulp-inject-file');

	var envSrcFocus    = './comop/'+current+'/src/';
	var envSrc         = './comop/'+current+'/src/*';
	var envSrcImg      = './comop/'+current+'/src/img/*';
	var envDist        = './comop/'+current+'/dist';
	var envDistDOS     = 'c:/gulp/comop/'+current+'/dist/*';
	var envDistImg     = './comop/'+current+'/dist/img';



	/* ________  ____  _______  ____
	  / ____/ / / /  |/  / __ \/ __ \
	 / /   / /_/ / /|_/ / / / / / / /
	/ /___/ __  / /  / / /_/ / /_/ /
	\____/_/ /_/_/  /_/\____/_____/
	*/

	gulp.task('chmod',['ftp'], function () {
		return ssh
		.exec(['chmod -R 775 /opt/webroot/cofax/static/bcom/desktop/evenements/'+current], {filePath: '/opt/webroot/cofax/static/bcom/desktop/evenements/'+current})
		.pipe(gulp.dest('logs'))
	})


	/*  ________________
	   / ____/_  __/ __ \
	  / /_    / / / /_/ /
	 / __/   / / / ____/
	/_/     /_/ /*/

		gulp.task('ftp',['html'],function() {
			return gulp.src(envDist+'/*',{cwd:__dirname})
			.pipe(ftp({
				host:config.host,
				username:config.username,
				password:config.password,
				dest:config.dest,
				watch:function(client) {client.on('write',function(o){console.log('Write %s', o.destination)});}
			}))
			.on('error', function(err) {
				console.log(err);
			});
		});

/*	    __  __________  _____
	   / / / /_  __/  |/  / /
	  / /_/ / / / / /|_/ / /
	 / __  / / / / /  / / /___
	/_/ /_/ /_/ /_/  /_/____*/

		gulp.task('html',['less'],function(event) {
			return gulp.src(envSrc+'.html')
			.pipe(prettify())
			.pipe(gulp.dest(envSrcFocus))
			.pipe(htmlmin({collapseWhitespace: true}))
			.pipe(injectfile({pattern: '<!--\\s*inject:<filename>-->'}))
			.pipe(replace('src=', 'data-src='))
			.pipe(gulp.dest(envDist))
		});


	/*  __    ________________
	   / /   / ____/ ___/ ___/
	  / /   / __/  \__ \\__ \
	 / /___/ /___ ___/ /__/ /
	/_____/_____//____/___*/

		gulp.task('less',['js'], function() {
			return gulp.src(envSrcFocus+'styles.less')
			.pipe(prettify())
			.pipe(gulp.dest(envSrcFocus))
			.pipe(less({plugins:[autoprefix]}))
			.pipe(cssmin())
			.pipe(rename({suffix: '.min'}))
			.pipe(gulp.dest(envDist));
		});


	/*     _______
	      / / ___/
	 __  / /\__ \
	/ /_/ /___/ /
	\____//___*/

		gulp.task('js',['images'], function() {
			return gulp.src(envSrc+'.js')
			.pipe(jshint())
			.pipe(jshint.reporter('default'))
			.pipe(prettify())
			.pipe(gulp.dest(envSrcFocus))
			.pipe(concat('functions.min.js'))
			.pipe(uglify())
			.pipe(gulp.dest(envDist));
		});


	/*  ______  ______   _________________
	   /  _/  |/  /   | / ____/ ____/ ___/
	   / // /|_/ / /| |/ / __/ __/  \__ \
	 _/ // /  / / ___ / /_/ / /___ ___/ /
	/___/_/  /_/_/  |_\____/_____//___*/

		gulp.task('images',function() {
			return gulp.src(envSrcImg)
			//.pipe(cache(imagemin({optimizationLevel:7,progressive: true,interlaced:true})))
			.pipe(gulp.dest(envDistImg));
		});


	/*                __
	 _      _____  / /_  ________  ______   _____  _____
	| | /| / / _ \/ __ \/ ___/ _ \/ ___/ | / / _ \/ ___/
	| |/ |/ /  __/ /_/ (__  )  __/ /   | |/ /  __/ /
	|__/|__/\___/_.___/____/\___/_/    |___/\___/*/

		gulp.task('webserver', function() {
			gulp.src('app')
			.pipe(webserver({
				host:'localhost',
				port: 10000,
				enable: true,
				livereload: false,
				directoryListing: true,
				open: true,
				fallback: './',
				proxies:[{source:'http://172.17.10.88:8080/',target:'http://localhost:10000'}]
			}));
		});


	/*  ____  _______________   __  ____  ______
	   / __ \/ ____/ ____/   | / / / / / /_  __/
	  / / / / __/ / /_  / /| |/ / / / /   / /
	 / /_/ / /___/ __/ / ___ / /_/ / /___/ /
	/_____/_____/_/   /_/  |_\____/_____/*/

		gulp.task('comop',['chmod'],function(){
		    gulp.watch(envSrc+'.js',['js','html','ftp']);
		    gulp.watch(envSrc+'.less',['less','html','ftp']);
		    gulp.watch(envSrc+'.html',['html','ftp']);
		    gulp.watch(envSrcImg,['images','ftp']);
		});
